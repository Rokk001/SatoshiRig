name: Build and Publish Docker Image

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  PACKAGE_NAME: satoshirig

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image name (lowercase)
        id: image
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="${OWNER_LOWER}/${{ env.PACKAGE_NAME }}"
          FULL_IMAGE="${{ env.REGISTRY }}/${IMAGE_NAME}"
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "full_image=${FULL_IMAGE}" >> $GITHUB_OUTPUT

      - name: Extract metadata (for tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.full_image }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Make package public automatically
        run: |
          set +e  # Don't exit on error - we'll handle failures gracefully
          PACKAGE_NAME="${{ env.PACKAGE_NAME }}"
          OWNER="${{ github.repository_owner }}"
          OWNER_LOWER=$(echo "${OWNER}" | tr '[:upper:]' '[:lower:]')

          echo "ðŸ” Making package public: ${PACKAGE_NAME}"
          echo "Repository: ${{ github.repository }}"
          echo "Owner: ${OWNER} (lowercase: ${OWNER_LOWER})"

          # Wait for package to be fully created after push
          echo "â³ Waiting for package to be available..."
          sleep 20

          # Try multiple methods with retries
          MAX_RETRIES=15
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = false ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo ""
            echo "ðŸ”„ Attempt ${RETRY_COUNT}/${MAX_RETRIES}..."

            # Method 1: User endpoint
            echo "Trying user endpoint..."
            RESULT=$(gh api -X PATCH /user/packages/container/${PACKAGE_NAME} -f visibility=public 2>&1)
            if [ $? -eq 0 ]; then
              echo "âœ… SUCCESS: Package set to public via user endpoint!"
              echo "${RESULT}"
              SUCCESS=true
              break
            else
              echo "âŒ User endpoint failed: ${RESULT}"
            fi

            # Method 2: Org endpoint (lowercase)
            echo "Trying org endpoint (${OWNER_LOWER})..."
            RESULT=$(gh api -X PATCH /orgs/${OWNER_LOWER}/packages/container/${PACKAGE_NAME} -f visibility=public 2>&1)
            if [ $? -eq 0 ]; then
              echo "âœ… SUCCESS: Package set to public!"
              echo "${RESULT}"
              SUCCESS=true
              break
            else
              echo "âŒ Org endpoint (${OWNER_LOWER}) failed: ${RESULT}"
            fi

            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ Retrying in 10 seconds..."
              sleep 10
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo ""
            echo "âŒ All gh api attempts failed. Trying curl..."
            
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
            
            # Try with curl
            RESULT=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X PATCH \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{"visibility":"public"}' \
              "https://api.github.com/user/packages/container/${PACKAGE_NAME}" 2>&1)
            
            HTTP_CODE=$(echo "${RESULT}" | grep "HTTP_CODE:" | cut -d: -f2)
            if [ "${HTTP_CODE}" = "204" ] || [ "${HTTP_CODE}" = "200" ]; then
              echo "âœ… SUCCESS: Package set to public via curl!"
              SUCCESS=true
            else
              echo "âŒ Curl user endpoint failed: ${RESULT}"
              
              RESULT=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X PATCH \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Authorization: Bearer ${TOKEN}" \
                -H "Content-Type: application/json" \
                -d '{"visibility":"public"}' \
                "https://api.github.com/orgs/${OWNER_LOWER}/packages/container/${PACKAGE_NAME}" 2>&1)
              
              HTTP_CODE=$(echo "${RESULT}" | grep "HTTP_CODE:" | cut -d: -f2)
              if [ "${HTTP_CODE}" = "204" ] || [ "${HTTP_CODE}" = "200" ]; then
                echo "âœ… SUCCESS: Package set to public via curl org endpoint!"
                SUCCESS=true
              fi
            fi
          fi

          if [ "$SUCCESS" = true ]; then
            echo ""
            echo "âœ…âœ…âœ… Package is now PUBLIC! âœ…âœ…âœ…"
            echo "Verify at: https://ghcr.io/v2/${OWNER_LOWER}/${PACKAGE_NAME}/manifests/latest"
            echo "Package URL: https://github.com/${OWNER}?tab=packages&package_name=${PACKAGE_NAME}"
          else
            echo ""
            echo "âš ï¸  WARNING: Could not set package to public automatically."
            echo "The package was created but may still be private."
            echo "Please check: https://github.com/${OWNER}?tab=packages"
            echo ""
            echo "Note: This is not a fatal error. The Docker image was built and pushed successfully."
            echo "You may need to manually set the package visibility in GitHub Settings > Packages."
          fi

          # Don't fail the workflow if we couldn't set it to public
          # The image was built and pushed successfully, which is the main goal
          exit 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
