services:
  satoshirig:
    container_name: satoshirig
    # Option 1: Build from local Dockerfile (default)
    build:
      context: .
      dockerfile: Dockerfile
    # Option 2: Use public image from GHCR (uncomment image: and comment out build: above)
    # image: ghcr.io/rokk001/satoshirig:latest
    restart: unless-stopped
    environment:
      # REQUIRED: set your BTC wallet address
      - WALLET_ADDRESS=${WALLET_ADDRESS}
      # OPTIONAL: config path inside container
      - CONFIG_FILE=/app/config/config.toml
      # OPTIONAL: statistics file path (default: /app/data/statistics.json)
      - STATS_FILE=/app/data/statistics.json
      # Compute backend: cpu | cuda | opencl
      - COMPUTE_BACKEND=${COMPUTE_BACKEND:-cpu}
      # GPU index for CUDA/OpenCL backends
      - GPU_DEVICE=${GPU_DEVICE:-0}
      # NVIDIA container runtime envs (only for NVIDIA GPU)
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      # Web dashboard port (default: 5000)
      - WEB_PORT=${WEB_PORT:-5000}
    volumes:
      - ./config:/app/config:ro
      - ./data:/app/data  # Persistent data directory for statistics
    ports:
      - "${WEB_PORT:-5000}:5000"
    labels:
      # Docker Desktop WebUI Navigation
      - "com.docker.compose.service.satoshirig.webui=http://localhost:${WEB_PORT:-5000}"
      - "com.docker.compose.service.webui=http://localhost:${WEB_PORT:-5000}"
      # Portainer WebUI Navigation
      - "io.portainer.container.http.port=5000"
      - "io.portainer.container.http.url=http://localhost:${WEB_PORT:-5000}"
      - "io.portainer.accesscontrol.public=true"
      # Traefik (if using Traefik)
      - "traefik.enable=true"
      - "traefik.http.services.satoshirig.loadbalancer.server.port=5000"
      # Open Container Initiative Labels
      - "org.opencontainers.image.title=SatoshiRig"
      - "org.opencontainers.image.description=Bitcoin Solo Mining Client WebUI"
      - "org.opencontainers.image.url=http://localhost:${WEB_PORT:-5000}"
    # NVIDIA GPU support (required for NVIDIA GPU usage):
    # Uncomment the next line to enable NVIDIA runtime
    # This is required for containers that need NVIDIA GPU access
    # runtime: nvidia
    # Alternative: use deploy.resources.reservations.devices for newer Docker Compose
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    # AMD/OpenCL (expose iGPU if used):
    # devices:
    #   - /dev/dri:/dev/dri
    command: ["python", "-m", "SatoshiRig"]
